# QUANT-EVO Research Engine: 프롬프트 품질 평가 가이드

**목적**: 로그 통계만을 기반으로 AI 프롬프트의 공격성과 신호 품질을 평가

**핵심 원칙**:
- ❌ 손익 기반 튜닝 절대 금지
- ✅ 로그 통계만으로 평가
- ✅ 핵심 지표: BUY 비율, intents/min, REJECT 사유
- ✅ 단타 승률 가능성 정의
- ✅ 과최적화 위험 경고

---

## 📊 사용 방법

### Step 1: 로그 수집

APP64와 APP32를 실행하여 JSON Lines 로그 생성:
```bash
# 터미널 1
python app64/signal_engine.py &

# 터미널 2
python app32/main.py &

# 최소 1-2분 실행 (50-100개 신호 수집)
```

### Step 2: 리서치 엔진 실행

```bash
python tools/research_engine.py
```

### Step 3: 리포트 해석

콘솔 출력을 분석하여 다음을 확인:
1. 현재 프롬프트 상태 평가
2. 위험 신호 (HIGH/MEDIUM)
3. 승률 가능성 점수
4. 다음 단계 체크리스트

---

## 📈 핵심 지표 설명

### 1. 공격성 (Aggressiveness)

**정의**: 프롬프트가 신호를 얼마나 자주 생성하는가?

**지표**: `intents_per_minute` (분당 신호 수)

```
매우 보수적:  < 5 signals/min    (거래 기회 매우 적음)
보수적:      5-10 signals/min    (거래 기회 적음)
중간:        10-15 signals/min   (균형잡힘)
공격적:      15-20 signals/min   (빈번한 거래)
매우 공격적:  > 20 signals/min    (과도한 신호)
```

**평가**:
- ✅ 10-15 signals/min이 이상적
- ⚠️ < 5 또는 > 20은 검토 필요

---

### 2. 필터 품질 (Filter Quality)

**정의**: 생성된 신호 중 얼마나 많은 신호가 실행되는가?

**지표**: `sent_rate` (실행률 %)

```
sent_rate = EXEC_SENT / SIGNAL_CREATED * 100%
```

```
매우 관대한 필터:  > 95%  (거의 모든 신호 실행 = 위험)
관대한 필터:      85-95%  (대부분 신호 실행)
합리적 필터:      50-85%  (적절한 필터링)
엄격한 필터:      30-50%  (신호 많이 거절)
매우 엄격한 필터:  < 30%  (거의 모든 신호 거절)
```

**평가**:
- ✅ 50-85%가 이상적 (충분한 필터링 + 거래 기회)
- ⚠️ > 90%는 필터가 무시되는 것으로 판단
- ⚠️ < 30%는 기회 상실로 판단

---

### 3. BUY 비율 (Buy Ratio)

**정의**: 실행된 신호 중 매수 신호의 비율

**지표**: `buy_ratio = BUY_ACTIONS / TOTAL_ACTIONS`

```
매도/관망 편향:  < 0.40  (매수 신호 부족)
약간 관망 편향:  0.40-0.50
균형잡힘:       0.50-0.70 (이상적)
약간 매수 편향:  0.70-0.80
강한 매수 편향:  > 0.80  (단방향 베팅 = 위험)
```

**평가**:
- ✅ 0.50-0.70이 이상적 (상승/하락장 모두 대응)
- ⚠️ < 0.40 또는 > 0.80은 균형 문제
- 🚨 > 0.90은 단방향 베팅 위험

---

### 4. AI 점수 신뢰도

**정의**: 생성된 신호, 실행된 신호, 거절된 신호의 AI 신뢰도 점수 비교

**지표**: `ai_score_stats`

```python
{
  'created': {'mean': 0.65, 'std': 0.08, 'median': 0.66},
  'sent': {'mean': 0.70, 'std': 0.07, 'median': 0.71},     # 높을수록 좋음
  'rejected': {'mean': 0.62, 'std': 0.06, 'median': 0.61}, # 낮을수록 좋음
}
```

**평가**:
- ✅ `ai_score_sent` > `ai_score_rejected` (필터 효율 좋음)
- ✅ `ai_score_sent` >= 0.70 (신뢰도 높음)
- ✅ `std` <= 0.08 (일관성 높음)
- 🚨 `ai_score_sent` < `ai_score_rejected` (필터 역전 = 위험)

---

### 5. 거절 이유 분석

**정의**: 신호가 거절된 이유를 분석

**거절 사유**:
- `TTL_EXPIRED`: 신호 유효시간 초과
- `DAILY_LIMIT`: 일일 매수 한도 도달
- `COOLDOWN`: 마지막 거래 후 쿨다운 미경과
- `ONE_POSITION`: 기존 포지션 존재

**평가**:
- ✅ 여러 사유가 비슷한 비율로 분포 (필터 균형 좋음)
- ⚠️ 한 가지 사유만 70% 이상 (필터 편향 = 다른 위험 놓칠 수 있음)

```
이상적: TTL_EXPIRED 30%, DAILY_LIMIT 25%, COOLDOWN 25%, ONE_POSITION 20%
문제:   COOLDOWN 80% (다른 필터 작동 안 함)
```

---

## 🎯 단타 승률 가능성 (Day Trading Win Rate Potential)

**정의**: 현재 프롬프트 상태에서 단타 거래로 성공할 가능성

### 계산 방식

```
Win Rate Potential = 
  0.35 * (AI Score Quality) +
  0.25 * (AI Score Consistency) +
  0.25 * (Rejection Control) +
  0.15 * (Buy Balance)
```

### AI Score Quality (35%)
```
>= 0.75 → 1.0 (매우 높음)
0.70-0.75 → 0.85 (높음)
0.65-0.70 → 0.7 (양호)
0.60-0.65 → 0.5 (낮음)
< 0.60 → 0.2 (매우 낮음)
```

### AI Score Consistency (25%)
```
std <= 0.05 → 1.0 (매우 일관됨)
0.05 < std <= 0.08 → 0.8 (일관됨)
0.08 < std <= 0.12 → 0.6 (보통)
std > 0.12 → 0.3 (불일관)
```

### Rejection Control (25%)
```
sent_rate < 15% → 1.0 (우수한 필터링)
15-30% → 0.8 (합리적 필터링)
30-50% → 0.5 (낮은 필터링)
> 50% → 0.2 (과도한 필터링)
```

### Buy Balance (15%)
```
0.50-0.70 → 1.0 (균형잡힘)
0.40-0.80 → 0.8 (대체로 균형)
0.30-0.90 → 0.5 (불균형)
< 0.30 or > 0.90 → 0.2 (극단적 불균형)
```

### 최종 평가

```
85-100%: EXCELLENT    → 실전 거래 테스트 시작 가능
70-85%:  GOOD         → 추가 데이터 수집 권장
55-70%:  FAIR         → 프롬프트 미세 조정 필요
40-55%:  POOR         → 주요 수정 필요
< 40%:   VERY_POOR    → 완전 재설계 필요
```

---

## ⚠️ 위험 신호 (Risk Signals)

### HIGH 레벨 위험 (즉시 조치)

1. **실행률 >95%** (필터 무시)
   - 원인: 거의 모든 신호가 실행됨
   - 위험: 나쁜 신호도 함께 실행
   - 조치: 필터 파라미터 검토

2. **AI 점수 역전** (REJECTED > SENT)
   - 원인: 거절된 신호가 실행 신호보다 점수 높음
   - 위험: 좋은 신호 거절, 나쁜 신호 실행
   - 조치: 필터 로직 완전히 재검토

### MEDIUM 레벨 경고 (모니터링)

1. **실행률 <20%** (과도한 필터)
   - 원인: 필터가 너무 엄격 또는 신호 품질 문제
   - 위험: 거래 기회 상실
   - 조치: 필터 파라미터 완화

2. **BUY 비율 극단적** (<30% 또는 >85%)
   - 원인: 단방향 베팅
   - 위험: 한쪽 방향만 수익, 반대쪽 손실
   - 조치: 프롬프트의 방향 편향 확인

3. **거절 이유 편중** (한 가지 >70%)
   - 원인: 한 가지 필터만 작동
   - 위험: 다른 위험 신호 놓침
   - 조치: 필터 균형 재조정

4. **신호 생성율 매우 낮음** (<2/min)
   - 원인: 프롬프트가 너무 보수적
   - 위험: 거래 기회 부족
   - 조치: 프롬프트 공격성 증가

5. **AI 점수 낮음** (<0.60)
   - 원인: 신뢰도 낮은 신호 실행
   - 위험: 잘못된 거래 가능성
   - 조치: 신호 생성 로직 검토

6. **데이터 부족** (<50개 신호)
   - 원인: 샘플 크기 부족
   - 위험: 통계적 신뢰도 낮음
   - 조치: 추가 데이터 수집

---

## 📋 다음 단계 체크리스트

### Stage 1: 데이터 수집
- **필요**: 최소 50개, 이상 100-200개 신호
- **확인**: `sample_size >= 50`
- **시간**: `(100 - current_signals) / intents_per_minute` 분

### Stage 2: 위험 평가
- **필요**: HIGH 레벨 위험 0개
- **확인**: `risks == []`
- **조치**: HIGH 위험 발견 시 해결

### Stage 3: 승률 가능성
- **필요**: 최소 70% 이상
- **확인**: `win_rate_potential >= 0.70`
- **조치**: 70% 미만이면 프롬프트 개선

### Stage 4: 신호 품질
- **필요**: 실행률 50-85% 범위
- **확인**: `50 <= sent_rate <= 85`
- **조치**: 범위 밖이면 필터 파라미터 조정

### Stage 5: 버전 안정성
- **필요**: 현재 버전을 기준선으로 설정
- **확인**: `version_id` 기록
- **조치**: 다음 버전과의 비교 기준점

### Stage 6: 다음 단계 결정

```
if win_rate >= 85%:
  → 실전 거래 테스트 시작
  
elif win_rate >= 70%:
  → 추가 데이터 수집 + 모니터링
  
elif win_rate >= 55%:
  → 프롬프트 미세 조정
  
elif win_rate >= 40%:
  → 프롬프트 주요 수정
  
else:
  → 프롬프트 완전 재설계
```

---

## 🔍 리포트 해석 예

### 예제 1: 좋은 상태 (실전 준비)

```
공격성: 중간 (11 signals/min)          ✅
필터: 합리적 (75% 실행률)              ✅
BUY 비율: 65%                          ✅
AI 점수: 0.72 (좋음)                   ✅
거절 이유: 다양한 분포                  ✅
위험: 없음                             ✅

승률 가능성: 86% (EXCELLENT)            ✅

다음 단계: 실전 거래 테스트 시작
```

### 예제 2: 주의 필요 (개선 필요)

```
공격성: 보수적 (3 signals/min)         ⚠️
필터: 합리적 (72% 실행률)              ✅
BUY 비율: 85%                          ⚠️ (매수 편향)
AI 점수: 0.68 (양호)                   ✅
거절 이유: COOLDOWN 80% (편중)         ⚠️
위험: AI 점수 역전 (REJECTED > SENT)    🚨

승률 가능성: 62% (FAIR)                ⚠️

다음 단계: 프롬프트 미세 조정
- BUY 비율을 60% 수준으로 감소
- 필터 이유 다양성 개선
- AI 점수 필터 로직 검토
```

### 예제 3: 위험한 상태 (재검토 필요)

```
공격성: 매우 높음 (25 signals/min)     🚨
필터: 무시 (98% 실행률)                🚨
BUY 비율: 92%                          🚨
AI 점수: 0.55 (낮음)                   🚨
거절 이유: COOLDOWN 90%                🚨
위험: AI 점수 역전, 실행률 과도         🚨

승률 가능성: 28% (VERY_POOR)          ❌

다음 단계: 프롬프트 완전 재설계 필요
- 신호 생성 로직 근본적 재검토
- 필터 파라미터 모두 재설정
- BUY 비율 균형 재조정
```

---

## 💡 활용 시나리오

### 시나리오 1: 프롬프트 A vs B 비교

```bash
# 프롬프트 A로 200개 신호 수집
python app64/signal_engine.py &
# ... 180분 실행

python tools/research_engine.py
# → 결과 저장

# 프롬프트 B로 변경
# → 다시 200개 신호 수집 및 분석

# 비교:
# A: 승률 79%, BUY 65%, AI 0.71
# B: 승률 68%, BUY 55%, AI 0.68
# → A가 더 나음
```

### 시나리오 2: 파라미터 튜닝 검증

```bash
# 현재 상태 (베이스라인)
python tools/research_engine.py
# → 베이스라인: 승률 65%

# 필터 파라미터 조정 (cooldown 30초 → 45초)
# → 로그 파일 백업 및 초기화

# 새로운 200개 신호 수집
python app64/signal_engine.py &

python tools/research_engine.py
# → 새 승률: 72% (개선됨!)
# → 다른 지표 확인
```

### 시나리오 3: 장기 안정성 모니터링

```bash
# 매일 아침 분석
for day in {1..7}:
  python tools/research_engine.py > reports/day_${day}.txt
  
# 각 일자의 승률 가능성 추이 확인
# Day 1: 75%
# Day 2: 76%
# Day 3: 78%
# Day 4: 73%
# Day 5: 75%
# ...
# → 대체로 안정적 (74-78% 범위)
```

---

## 📌 주의사항

### ❌ 절대 하지 말 것

1. **손익을 기반으로 프롬프트 조정**
   - 이 도구는 로그 통계만 분석
   - 실제 거래 결과는 포함 안 됨
   - 손익에 기반한 과최적화는 위험

2. **데이터 부족 상태에서 결정**
   - 최소 50개, 이상 100개 이상의 신호 필요
   - < 50개에서의 결론은 신뢰도 낮음

3. **한 가지 지표만 봄**
   - AI 점수만, BUY 비율만 등으로 판단하지 말 것
   - 모든 구성 요소를 종합적으로 봐야 함

4. **극단적 조정**
   - 한 번에 큰 변화 주지 말 것
   - 작은 변화 후 충분한 데이터 수집 후 재평가

### ✅ 권장 사항

1. **정기적 평가**
   - 100개 신호마다 한 번씩 평가
   - 매주 또는 매일 경향 모니터링

2. **버전 관리**
   - 각 버전의 평가 결과를 기록
   - params_version_id로 추적

3. **느린 개선**
   - 한 번에 한 가지씩 변경
   - 충분한 데이터 후 효과 검증

4. **위험 신호 주시**
   - HIGH 레벨 위험은 즉시 해결
   - MEDIUM 경고는 정기적 모니터링

---

## 📚 관련 도구

- [tools/analyze_logs.py](../../tools/analyze_logs.py) - 기본 로그 분석
- [JSON_LINES_LOGGING_GUIDE.md](../../JSON_LINES_LOGGING_GUIDE.md) - 로그 형식
- [PROMPT_EVALUATION_FRAMEWORK.md](../../PROMPT_EVALUATION_FRAMEWORK.md) - 평가 프레임워크

---

**최종 기억할 점:**

이 리서치 엔진은 **로그 통계만으로** 프롬프트의 공격성과 신호 품질을 평가합니다.
손익, 거래 결과, 시장 조건은 포함하지 않습니다.

따라서:
- ✅ 프롬프트의 기계적 행동 이해 가능
- ✅ 안정적인 신호 생성 능력 검증 가능
- ✅ 위험한 필터 설정 식별 가능
- ❌ 손익 예측 불가능
- ❌ 과최적화 확인 불가능

실전 거래 전에는 반드시 **작은 규모부터 시작**하고, 실제 거래 결과를 지켜보세요!

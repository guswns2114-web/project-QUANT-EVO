# 프롬프트 리라이터 제안서

**역할**: 프롬프트 리라이터 (신호 생성 품질/빈도 균형 개선)  
**목표**: 수익이 아니라 신호 생성 최적화  
**근거 데이터**:
- intents/min: 1.11 (목표: 10-15)
- AI 점수 평균: 0.685
- BUY 비율: 50% ✓ (정상)
- 승률 가능성: 79.5% (내부 추정)
- 데이터 수량: 충분 (100+ 신호) ✓

---

## [요약 판단]

**현재 프롬프트 상태**:
✅ **품질**: 안정적 (BUY/SELL 균형, 점수 일관성)
❌ **빈도**: 극도로 낮음 (1.11/min → 10-15/min 필요)

**근본 원인**: 신호 신뢰도 기준이 **실제 신호 평균과 거의 같아서** 탐색이 제한됨
- 현재 ai_score_cut: 0.70
- 실제 신호 평균: 0.685
- 간격: 0.015 (극도로 작음)

**결론**: 기준을 **현실 수준에 맞춰** 조정하면서 거절 필터로 품질 보정 가능

---

## [현재 프롬프트의 한계]

### 구조적 병목 1️⃣: **ai_score_cut 너무 높음 (상단 제약)**

```
문제:
  - 기준값 (cut): 0.70
  - 실제 신호 평균: 0.685
  - 상황: "평균이 기준에 못 미친다"

물리적 의미:
  - 신호 점수 분포: 0.55 ~ 0.90
  - 0.70 이상 신호만 생성 가능
  - 0.55 ~ 0.70 범위의 신호는 모두 필터됨

영향:
  - 약 40% 신호가 기준 미달로 폐기
  - intents/min 1.11이 그 이상으로 못 올라감
  - "높은 기준이 신호 기회를 막고 있음"

증거:
  ✓ 거절된 신호의 AI 점수(0.70) > 실행 신호의 AI 점수(0.655)
    → 필터 역전! (품질 필터 자체가 문제)
```

### 구조적 병목 2️⃣: **복합 조건의 누적 제약**

```
현재 조건:
1. VWAP 이상 가격 요구 (1개 심볼 기준 ~70% 만족)
2. 최대 3개 심볼만 추적 (우주 제한)
3. 30초 window 내 분석 (시간 제약)
4. 매수 비율 ≥ 65% 요구 (시장 조건 필터)
5. AI 점수 ≥ 0.70 요구 (신뢰도 필터)

복합 확률:
  - 각 조건이 독립적으로 50% 만족률이라면
  - 모두 동시 만족 확률 = 0.5^5 = 3.125%
  - "5개 신호 중 1개만 생성"

실제:
  - VWAP + 볼륨 + AI 점수 모두 만족해야 함
  - 누적 효과로 신호 생성 기회 급격히 감소
  - "보수적 조건의 조합"으로 탐색 불가능
```

### 구조적 병목 3️⃣: **시장 조건 필터의 엄격함 (vol_spike, book_ratio)**

```
현재 설정:
  - vol_spike_min: 2.0 (변동성 2배 이상)
  - book_ratio_min: 1.30 (호가 레시오 1.30 이상)
  - require_price_above_vwap: true (추가 조건)

문제:
  - 이들은 "특정 시장 상황"에서만 만족
  - 정상 시장에서는 vol_spike 1.5배, book_ratio 1.2배 수준이 일반적
  - 설정이 "시뮬레이션" 환경에는 너무 엄격할 수 있음

모의 거래의 특성:
  - 실시간 호가 변동이 제한적
  - 변동성이 현실보다 낮을 수 있음
  - 결과: 조건을 거의 만족하지 못함
```

---

## [현재 프롬프트 코드]

### 현재 signal_engine.py 로직

```python
# 현재 프롬프트 (simple version in code):
score = random.uniform(0.55, 0.90)  # 신호 점수 생성
action = "BUY" if score >= cut else "HOLD"  # cut=0.70

# 실제 프롬프트 (전체 AI instruction):
"""
너는 AI 신호 생성 엔진이다.

역할: 
- 주식 심볼 분석 후 BUY/SELL/HOLD 신호 생성
- 신뢰도 점수 (0-1) 함께 제공

조건 (모두 만족 필요):
1. VWAP 이상 가격에서만 신호 생성
2. 최근 30초 윈도우에서 분석
3. 변동성 스파이크 2배 이상 (vol_spike_min: 2.0)
4. 호가 레시오 1.3 이상 (book_ratio_min: 1.30)
5. 매수 의향 비율 65% 이상 (buy_ratio_min: 0.65)
6. AI 신뢰도 70% 이상 (ai_score_cut: 0.70)

출력: {"symbol": "005930", "action": "BUY", "ai_score": 0.75}
"""
```

---

## [3가지 시나리오 비교표]

| **지표** | **현재 (Baseline)** | **Scenario C (권장)** | **Scenario A (공격)** | **Scenario B (보조)** |
|----------|-------------------|----------------------|----------------------|----------------------|
| **ai_score_cut** | 0.70 | 0.67 ⬇️ | 0.65 ⬇️⬇️ | 0.70 |
| **vol_spike_min** | 2.0 | 2.0 | 2.0 | 1.7 ⬇️ |
| **book_ratio_min** | 1.30 | 1.30 | 1.30 | 1.2 ⬇️ |
| **require_price_above_vwap** | true | true | true | false ⬇️ |
| | | | | |
| **예상 intents/min** | 1.11 | **1.33** | **1.67** | **2.22** |
| **증가율** | - | +20% | +50% | +100% |
| **신호 품질 (AI 점수)** | 0.685 | 0.68 | 0.675 | 0.665 |
| **필터 부하** | 낮음 | 낮음 | 중간 | 높음 |
| **거절률 예상 변화** | 20% | 22% | 30% | 40% |
| **위험도** | - | 🟢 **낮음** | 🟡 중간 | 🔴 높음 |
| **권장도** | - | ⭐⭐⭐ | ⭐⭐ | ⭐ |

---

## [Scenario C: 권장 프롬프트 (조건 완화 v1)]

### 변경 내용

```json
{
  "version": "2026-01-28_REWRITE_C",
  "universe": {
    "max_symbols": 3,
    "allowed_markets": ["KOSDAQ", "KOSPI"],
    "exclude_locked_limit": true
  },
  "signal": {
    "window_sec": 30,
    "vol_spike_min": 2.0,
    "buy_ratio_min": 0.65,
    "book_ratio_min": 1.30,
    "require_price_above_vwap": true,
    "breakout_hold_sec_max": 10,
    "ai_score_cut": 0.67,          ⬅️ 변경: 0.70 → 0.67
    "signal_ttl_ms": 5000
  },
  "execution": {
    "poll_interval_ms": 250,
    "order_type": "MARKET",
    "max_orders_per_day": 8,
    "cooldown_sec": 30,
    "one_position_only": true
  },
  "risk": {
    "stop_loss_pct": 0.012,
    "take_profit_pct": 0.03,
    "daily_max_loss_pct": 0.03,
    "kill_switch_on_errors": true,
    "max_consecutive_losses": 2
  }
}
```

### 프롬프트 업데이트 (AI Instruction)

```
【Updated AI Signal Generation Prompt - Scenario C】

너는 AI 신호 생성 엔진이다.

【역할】
- 주식 심볼 분석 후 BUY/SELL/HOLD 신호 생성
- 신뢰도 점수(0-1) 함께 제공

【필수 조건 (모두 만족해야 함)】
1. VWAP 이상 가격에서만 신호 생성 (가격 신뢰도)
2. 최근 30초 윈도우에서 기술적 분석 수행
3. 변동성 스파이크 2배 이상 (vol_spike_min: 2.0)
4. 호가 레시오 1.3 이상 (book_ratio_min: 1.30)
5. 매수 의향 비율 65% 이상 (buy_ratio_min: 0.65)
6. AI 신뢰도 67% 이상 (ai_score_cut: 0.67) ⬅️ 조정됨

【점수 계산】
- 범위: 0.55 ~ 0.90
- 0.67 이상: 신호 생성 (BUY/SELL)
- 0.55 ~ 0.67: HOLD (필터됨)
- 이유: 현재 평균 신호 점수(0.685)가 기준을 초과하도록 조정
  → 탐색 범위 확대

【출력 형식】
{
  "symbol": "005930",
  "action": "BUY",
  "ai_score": 0.68,
  "reasoning": "VWAP 위, 변동성 스파이크 감지, 매수 비율 70%"
}

【필터 전략】
- 낮은 점수 신호(0.67~0.70)는 거절 필터에서 처리
- 이중 필터: AI 기준 + 거절 필터 (TTL, COOLDOWN, ONE_POSITION)
- 품질 보정: 앞단 탐색 확대 + 뒷단 필터 강화

【주의】
- 신호는 증가하지만, 거절 필터가 품질을 유지
- 현재 거절 필터 작동 효율: 80% (실행) / 20% (거절)
- 새로운 신호도 같은 수준의 필터링 받음
```

### 예상 효과 (Scenario C)

```
변경 전:
  - intents/min: 1.11
  - 필터링되는 신호: 약 40% (기준 미달)
  - 거절률: 20%

변경 후:
  - intents/min: 1.33 (약 +20%)
  - 필터링되는 신호: 약 25% (기준 미달)
  - 거절률: 22% (거의 증가 없음)

이유:
  - ai_score_cut 0.03 하향조정
  - 실제 신호 분포(0.55~0.90)에서 추가 15% 포함
  - 거절 필터의 효율성 유지
```

---

## [Scenario A: 공격적 프롬프트]

### 변경 내용

```json
{
  "signal": {
    ...
    "ai_score_cut": 0.65,          ⬅️ 변경: 0.70 → 0.65 (더 공격적)
    ...
  }
}
```

### 프롬프트 업데이트

```
【Scenario A: Aggressive Signal Generation】

...기존과 동일하되, 다음만 변경...

【점수 계산】
- 범위: 0.55 ~ 0.90
- 0.65 이상: 신호 생성 (BUY/SELL)
- 0.55 ~ 0.65: HOLD (필터됨)
- 이유: 신호 생성 기회 최대화
  → 낮은 점수 신호도 포함하고 거절 필터로 조정

【리스크 주의】
- 신뢰도 낮은 신호(0.65~0.70) 다수 생성
- 거절 필터 부하 증가 예상 (TTL 거절 증가)
- 거절 필터 효율성 저하 가능성
```

### 예상 효과 (Scenario A)

```
변경 전:
  - intents/min: 1.11
  - 필터링되는 신호: 약 40%
  - 거절률: 20%

변경 후:
  - intents/min: 1.67 (약 +50%)
  - 필터링되는 신호: 약 15% (기준 미달)
  - 거절률: 28-30% (10% 증가)

이유:
  - ai_score_cut 0.05 하향조정 (Scenario C보다 더 공격)
  - 신호 생성 약 50% 증가
  - 거절 필터의 TTL_EXPIRED 증가 (신호 많아지면 일부 유효시간 초과)
```

---

## [Scenario B: 시장 필터 완화]

### 변경 내용

```json
{
  "signal": {
    "window_sec": 30,
    "vol_spike_min": 1.7,          ⬅️ 변경: 2.0 → 1.7
    "buy_ratio_min": 0.65,
    "book_ratio_min": 1.2,         ⬅️ 변경: 1.30 → 1.2
    "require_price_above_vwap": false,  ⬅️ 변경: true → false
    "breakout_hold_sec_max": 10,
    "ai_score_cut": 0.70,          ⬅️ 유지 (AI 기준은 유지)
    "signal_ttl_ms": 5000
  }
}
```

### 프롬프트 업데이트

```
【Scenario B: Market Filter Relaxation】

...기존과 동일하되, 다음만 변경...

【필수 조건】
1. 가격 조건: VWAP 기준 폐지 (대신 최근 고가/저가 참고)
2. 최근 30초 윈도우에서 기술적 분석 수행
3. 변동성 스파이크 1.7배 이상 (완화: 2.0 → 1.7)
4. 호가 레시오 1.2 이상 (완화: 1.30 → 1.2)
5. 매수 의향 비율 65% 이상
6. AI 신뢰도 70% 이상 (유지)

【이론】
- VWAP 조건 제거: 모든 시장 상황에서 신호 생성 가능
- vol_spike 1.7배로 완화: 보통 변동성도 포함
- book_ratio 1.2로 완화: 시장 대기 상황도 포함
- 결과: 신호 생성 기회 약 2배 증가

【리스크】
- VWAP 조건 없으면 "가격이 떨어지는 상황"에서도 신호 생성 가능
- vol_spike 1.7은 노이즈 신호 포함 가능성 증가
- 시뮬레이션에서 실현되지 않을 수 있음
```

### 예상 효과 (Scenario B)

```
변경 전:
  - intents/min: 1.11
  - 시장 조건 필터: VWAP + vol_spike(2.0) + book_ratio(1.3)
  - 거절률: 20%

변경 후:
  - intents/min: 2.22 (약 +100%, 2배)
  - 시장 조건 필터: vol_spike(1.7) + book_ratio(1.2)
  - 거절률: 38-40% (거절 폭 증가)

이유:
  - VWAP 조건 제거로 신호 기회 30% 증가
  - vol_spike / book_ratio 완화로 추가 30% 증가
  - 하지만 거절 필터(TTL, COOLDOWN)가 부하 증가로 인해 거절률 상승
```

---

## [3가지 시나리오 정성 비교]

### 📊 신호 품질 vs 빈도 트레이드오프

```
┌─────────────────────────────────────────────────────┐
│         신호 빈도 (intents/min)                     │
│                                                     │
│ 2.22 ┤                                        ◇ B   │
│      │                                        (위험) │
│ 1.67 ┤                                   ◆ A         │
│      │                                   (중간)      │
│ 1.33 ┤                              ● C ⭐          │
│      │                              (권장)          │
│ 1.11 ┤ ▲ Current                                    │
│      │                                             │
│ 0.70 ├─────────────────────────────────────────   │
│  품질│     적절         중간          떨어짐        │
└─────────────────────────────────────────────────────┘

각 시나리오의 위치:
- ▲ Current: 1.11/min, 높은 품질 (하지만 신호 부족)
- ● C (권장): 1.33/min, 품질 유지, 안정적 개선
- ◆ A: 1.67/min, 품질 하향, 중간 거절률
- ◇ B: 2.22/min, 품질 크게 하향, 높은 거절률
```

---

## [Scenario 선택 기준]

### Scenario C ⭐ 권장하는 이유

```
1️⃣ 낮은 위험도
   - ai_score_cut만 0.03 하향조정
   - 다른 파라미터는 유지
   - 롤백 용이

2️⃣ 안정적 개선
   - intents/min: 1.11 → 1.33 (+20%)
   - 아직도 목표(10-15)에 미달
   - 다음 단계를 위한 검증 데이터 생성

3️⃣ 거절 필터 효율성 유지
   - 거절률 22% (현재 20% → 거의 변화 없음)
   - 기존 거절 필터 로직 변경 불필요
   - "전체 흐름 안정성" 유지

4️⃣ 다음 단계 명확함
   - Scenario C로 100-200 신호 수집
   - 효과 검증 후 Scenario A/B 고려
   - "점진적 개선 로드맵" 수립 가능

5️⃣ 금리스크
   - 과도한 신호 증가 없음
   - 거절 필터 오버플로우 걱정 없음
   - 시스템 안정성 보장
```

### Scenario A (공격) 고려 조건

```
언제 사용하는가?
- Scenario C로 100-200 신호 수집 후
- intents/min이 여전히 2.0 미만일 때
- 경영진이 추가 신호를 요청할 때

장점:
  ✓ +50% 신호 증가 (1.11 → 1.67)
  ✓ 기준이 현실적 (0.65는 많은 AI 모델의 일반적 기준)

주의:
  ✗ 거절률 증가 (20% → 28-30%)
  ✗ 저신뢰 신호 증가 (0.65-0.70 범위)
  ✗ 만약 거절 필터 부하 높아지면 시스템 불안정
```

### Scenario B (시장 필터) 비권장

```
왜 권장하지 않는가?

1. VWAP 조건 제거 위험
   - VWAP는 트렌드 확인의 기본
   - 제거하면 역추세 신호 생성 가능
   - "가격이 떨어지는데 BUY" 시나리오 발생

2. 시뮬레이션 환경 불일치
   - vol_spike 1.7, book_ratio 1.2는 모의 데이터에서 자주 만족
   - 실시장과 다를 수 있음
   - "시뮬레이션 오버피팅" 위험

3. 거절률 폭증
   - 20% → 40% (2배 증가)
   - 거절 필터에 의존도 높음
   - 필터 로직 변경 필요할 수 있음

차라리 Scenario A로 ai_score_cut만 조정하는 것이 더 안전
```

---

## [권장 시나리오 및 실행 계획]

### 📋 추천: Scenario C 적용

#### Step 1: 파라미터 변경 (수동)

```
현재 파일: shared/config/strategy_params.json

변경 전:
  "ai_score_cut": 0.70

변경 후:
  "ai_score_cut": 0.67

버전 업데이트:
  "version": "2026-01-28_REWRITE_C"
```

#### Step 2: 신호 수집 기간 (100-200개 목표)

```
수집 기간: 약 90-180분
- 현재: 1.11 signals/min → 9분에 10개
- Scenario C: 1.33 signals/min → 75-150분에 100-200개

진행 사항 확인:
- 10분마다 현재까지의 intents/min 계산
- 30분 후 조기 평가 (기준: 40개 신호 도달)
- 120분 경과 시 정량 평가 (기준: 160개 신호)
```

#### Step 3: 데이터 분석

```
수집 완료 후:
1. intents/min 재계산
   - 목표: 1.33 이상
   - 목표 초과 시: Scenario A 재고

2. 거절률 변화 확인
   - 예상: 20% → 22%
   - 초과 시: 거절 필터 부하 확인 필요

3. AI 점수 분포 재분석
   - 0.67-0.70 범위 신호 얼마나 생성되었는가?
   - 이들의 거절률이 높은가?

4. 거절 사유 분석
   - TTL_EXPIRED: 신호 유효시간 초과
   - COOLDOWN: 포지션 쿨다운
   - 비율 변화가 기대치 부합하는가?
```

#### Step 4: 최종 의사결정

```
Scenario C 효과 평가 후:

Case A: intents/min ≥ 1.50
  → 목표 달성 진행 중
  → Scenario A 재고 고려
  → "Scenario C가 효과 있음" 증명

Case B: 1.30 < intents/min < 1.50
  → 부분 개선됨
  → Scenario C 유지 + 추가 수집
  → 100-200 신호 수집 계속

Case C: intents/min ≤ 1.30
  → Scenario C 효과 미미
  → Scenario A 또는 B 검토 필요
  → "단순 ai_score_cut 조정만으로 부족" 결론
```

---

## [다음 단계 제안]

### 📅 실행 일정

```
Day 1 (지금):
  - 이 제안서 경영진 검토
  - 변경 승인 획득
  - 프롬프트 변경 준비

Day 2:
  - strategy_params.json 버전 업데이트 (2026-01-28_REWRITE_C)
  - ai_score_cut: 0.70 → 0.67 변경
  - 신호 수집 시작 (100-200개 목표)

Day 3-4:
  - 신호 수집 계속 진행
  - 120분 경과 시 정량 평가

Day 5:
  - 데이터 분석 완료
  - 결과 보고서 작성
  - Scenario A/B 재고 여부 결정
```

### 📊 추적 메트릭

```
매 10분마다 기록할 지표:

1. intents_per_minute
   - 누적 신호 / 경과 시간
   - 목표: 1.33 이상

2. rejection_rate
   - 거절된 신호 / 총 신호
   - 기준: 22% ±3%

3. ai_score_distribution
   - 0.55-0.65: __개
   - 0.65-0.70: __개 (새로 추가되는 영역)
   - 0.70-0.75: __개
   - 0.75-0.90: __개

4. rejection_reason_breakdown
   - TTL_EXPIRED: __%
   - COOLDOWN: __%
   - DAILY_LIMIT: __%
   - ONE_POSITION: __%
```

---

## [제약 사항 확인]

✅ **준수 사항**:
- 손익 기반 조정: ❌ 하지 않음 (로그 통계만 사용)
- 자동 적용: ❌ 하지 않음 (제안만 제시)
- 실계좌 거래: ❌ 금지 (시뮬레이션만 대상)
- 세 시나리오 비교: ✅ A/B/C 명확하게 비교
- 프롬프트 초안: ✅ 각 시나리오별 제시

❌ **하지 않은 것**:
- Scenario C 자동 적용 (수동 변경 필요)
- 손익 예측
- 실전 결과 보장

---

## [리라이터 결론]

### 🎯 최종 권장

```
현재 프롬프트는 "품질 중심"이지만 "기회 상실"하고 있습니다.

해결책: ai_score_cut을 0.70 → 0.67로 조정
  - 실제 신호 평균(0.685)과의 거리 축소
  - 거절 필터로 품질 보정 가능
  - 신호율 20% 증가 (1.11 → 1.33/min)
  - 위험도 낮음

실행:
  1. 경영진 승인
  2. strategy_params.json 수동 변경
  3. 100-200 신호 수집 후 평가
  4. 필요 시 Scenario A/B 검토

주의:
  - 손익 기반 의사결정 절대 금지
  - 로그 통계만 참고
  - "점진적 개선" 원칙 준수
```

---

**리라이터 제안**: 2026-01-28  
**다음 검토**: Scenario C 적용 후 100-200 신호 수집 완료 시점
